<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Help System & Fuzzy Matching - HackSimulator</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #0f0;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #0f0;
      border-bottom: 2px solid #0f0;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 30px 0;
      border: 1px solid #333;
      padding: 20px;
      background: #0a0a0a;
    }
    .test-section h2 {
      color: #00ff00;
      margin-top: 0;
    }
    button {
      background: #0a0a0a;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    button:hover {
      background: #0f0;
      color: #000;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .output {
      background: #000;
      border: 1px solid #333;
      padding: 15px;
      margin: 15px 0;
      white-space: pre-wrap;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #0f0;
    }
    .error {
      color: #ff0000;
    }
    .info {
      color: #00bfff;
    }
    .warning {
      color: #ffa500;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-left: 3px solid;
    }
    .test-result.pass {
      border-color: #0f0;
      background: rgba(0, 255, 0, 0.1);
    }
    .test-result.fail {
      border-color: #ff0000;
      background: rgba(255, 0, 0, 0.1);
    }
    .stats {
      margin: 20px 0;
      padding: 15px;
      background: #0a0a0a;
      border: 1px solid #0f0;
    }
    .stats span {
      margin-right: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üß™ HackSimulator - Help System & Fuzzy Matching Test Suite</h1>

  <div class="stats" id="stats">
    <span class="info">Tests: <span id="total-tests">0</span></span>
    <span class="success">Passed: <span id="passed-tests">0</span></span>
    <span class="error">Failed: <span id="failed-tests">0</span></span>
  </div>

  <!-- Test 1: Fuzzy Matching -->
  <div class="test-section">
    <h2>Test 1: Fuzzy Matching (Typo Detection)</h2>
    <p>Test of verkeerde spellingen worden herkend en correcte suggesties worden gegeven.</p>
    <button onclick="runFuzzyTests()">Run Fuzzy Matching Tests</button>
    <button onclick="clearOutput('fuzzy-output')">Clear Output</button>
    <div class="output" id="fuzzy-output">Wacht op test...</div>
  </div>

  <!-- Test 2: 3-Tier Help System -->
  <div class="test-section">
    <h2>Test 2: 3-Tier Progressive Help System</h2>
    <p>Test of herhaalde fouten leiden tot progressieve hints (Tier 1 ‚Üí 2 ‚Üí 3).</p>
    <button onclick="runTierTests()">Run 3-Tier Help Tests</button>
    <button onclick="clearOutput('tier-output')">Clear Output</button>
    <div class="output" id="tier-output">Wacht op test...</div>
  </div>

  <!-- Test 3: Man Pages -->
  <div class="test-section">
    <h2>Test 3: Man Pages (All 30 Commands)</h2>
    <p>Test of alle 30 commands een werkende man page hebben.</p>
    <button onclick="runManPageTests()">Run Man Page Tests</button>
    <button onclick="clearOutput('man-output')">Clear Output</button>
    <div class="output" id="man-output">Wacht op test...</div>
  </div>

  <!-- Test 4: Integration Test -->
  <div class="test-section">
    <h2>Test 4: Integration Test</h2>
    <p>Test het complete workflow: typo ‚Üí suggestie ‚Üí herhaling ‚Üí progressieve hint ‚Üí man page.</p>
    <button onclick="runIntegrationTest()">Run Integration Test</button>
    <button onclick="clearOutput('integration-output')">Clear Output</button>
    <div class="output" id="integration-output">Wacht op test...</div>
  </div>

  <script type="module">
    // Import core modules
    import registry from './src/core/registry.js';
    import vfs from './src/filesystem/vfs.js';
    import historyManager from './src/core/history.js';
    import helpSystem from './src/help/help-system.js';
    import fuzzy from './src/utils/fuzzy.js';

    // Import all commands
    import clearCmd from './src/commands/system/clear.js';
    import echoCmd from './src/commands/system/echo.js';
    import whoamiCmd from './src/commands/system/whoami.js';
    import dateCmd from './src/commands/system/date.js';
    import helpCmd from './src/commands/system/help.js';
    import manCmd from './src/commands/system/man.js';
    import historyCmd from './src/commands/system/history.js';

    import lsCmd from './src/commands/filesystem/ls.js';
    import cdCmd from './src/commands/filesystem/cd.js';
    import pwdCmd from './src/commands/filesystem/pwd.js';
    import catCmd from './src/commands/filesystem/cat.js';
    import touchCmd from './src/commands/filesystem/touch.js';
    import mkdirCmd from './src/commands/filesystem/mkdir.js';
    import rmCmd from './src/commands/filesystem/rm.js';
    import cpCmd from './src/commands/filesystem/cp.js';
    import mvCmd from './src/commands/filesystem/mv.js';
    import findCmd from './src/commands/filesystem/find.js';
    import grepCmd from './src/commands/filesystem/grep.js';

    import pingCmd from './src/commands/network/ping.js';
    import nmapCmd from './src/commands/network/nmap.js';
    import ifconfigCmd from './src/commands/network/ifconfig.js';
    import netstatCmd from './src/commands/network/netstat.js';
    import whoisCmd from './src/commands/network/whois.js';
    import tracerouteCmd from './src/commands/network/traceroute.js';

    import hashcatCmd from './src/commands/security/hashcat.js';
    import hydraCmd from './src/commands/security/hydra.js';
    import sqlmapCmd from './src/commands/security/sqlmap.js';
    import metasploitCmd from './src/commands/security/metasploit.js';
    import niktoCmd from './src/commands/security/nikto.js';

    // Register all commands
    const commands = [
      // System
      ['clear', clearCmd], ['echo', echoCmd], ['whoami', whoamiCmd],
      ['date', dateCmd], ['help', helpCmd], ['man', manCmd], ['history', historyCmd],
      // Filesystem
      ['ls', lsCmd], ['cd', cdCmd], ['pwd', pwdCmd], ['cat', catCmd],
      ['touch', touchCmd], ['mkdir', mkdirCmd], ['rm', rmCmd],
      ['cp', cpCmd], ['mv', mvCmd], ['find', findCmd], ['grep', grepCmd],
      // Network
      ['ping', pingCmd], ['nmap', nmapCmd], ['ifconfig', ifconfigCmd],
      ['netstat', netstatCmd], ['whois', whoisCmd], ['traceroute', tracerouteCmd],
      // Security
      ['hashcat', hashcatCmd], ['hydra', hydraCmd], ['sqlmap', sqlmapCmd],
      ['metasploit', metasploitCmd], ['nikto', niktoCmd]
    ];

    commands.forEach(([name, cmd]) => registry.register(name, cmd));

    // Test statistics
    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;

    function updateStats() {
      document.getElementById('total-tests').textContent = totalTests;
      document.getElementById('passed-tests').textContent = passedTests;
      document.getElementById('failed-tests').textContent = failedTests;
    }

    function logTest(outputId, testName, passed, message) {
      const output = document.getElementById(outputId);
      const resultClass = passed ? 'pass' : 'fail';
      const icon = passed ? '‚úÖ' : '‚ùå';

      totalTests++;
      if (passed) passedTests++;
      else failedTests++;

      updateStats();

      output.innerHTML += `<div class="test-result ${resultClass}">${icon} ${testName}\n${message}</div>`;
    }

    function clearOutput(outputId) {
      document.getElementById(outputId).innerHTML = '';
    }

    window.runFuzzyTests = async function() {
      const output = document.getElementById('fuzzy-output');
      output.innerHTML = '<span class="info">Running fuzzy matching tests...</span>\n\n';

      const tests = [
        { typo: 'pimg', expected: 'ping' },
        { typo: 'nmpa', expected: 'nmap' },
        { typo: 'lst', expected: 'ls' },
        { typo: 'cta', expected: 'cat' },
        { typo: 'whomai', expected: 'whoami' },
        { typo: 'echoo', expected: 'echo' },
        { typo: 'ifcnfig', expected: 'ifconfig' },
        { typo: 'netsat', expected: 'netstat' },
        { typo: 'hashct', expected: 'hashcat' },
        { typo: 'hydre', expected: 'hydra' }
      ];

      for (const test of tests) {
        const allCommands = registry.list();
        const suggestion = fuzzy.findClosestCommand(test.typo, allCommands, 2);

        const passed = suggestion === test.expected;
        const message = `Typo: "${test.typo}" ‚Üí Suggestion: "${suggestion || 'none'}" (Expected: "${test.expected}")`;

        logTest('fuzzy-output', `Fuzzy Match: ${test.typo}`, passed, message);
      }

      output.innerHTML += '\n<span class="success">‚úÖ Fuzzy matching tests completed!</span>';
    };

    window.runTierTests = async function() {
      const output = document.getElementById('tier-output');
      output.innerHTML = '<span class="info">Running 3-tier help system tests...</span>\n\n';

      // Reset error tracking
      helpSystem.errorCount = {};

      const fakeCommand = 'nonexistentcmd';
      const suggestion = 'nmap';

      // Test Tier 1 (first error)
      helpSystem.recordError(fakeCommand);
      const tier1 = helpSystem.getHelp(fakeCommand, suggestion);
      const hasTier1Elements = tier1.includes('Bedoelde je') && tier1.includes(suggestion);
      logTest('tier-output', 'Tier 1: First Error (Simple Suggestion)', hasTier1Elements,
        `Should show suggestion.\nGot: ${tier1.substring(0, 100)}...`);

      // Test Tier 2 (2-3 repeated errors)
      helpSystem.recordError(fakeCommand);
      helpSystem.recordError(fakeCommand);
      const tier2 = helpSystem.getHelp(fakeCommand, suggestion);
      const hasTier2Elements = tier2.includes('üí°') && (tier2.includes('Voorbeeld') || tier2.includes('help'));
      logTest('tier-output', 'Tier 2: Repeated Error (Progressive Hint)', hasTier2Elements,
        `Should show example or help hint.\nGot: ${tier2.substring(0, 150)}...`);

      // Test Tier 3 (4+ persistent errors)
      helpSystem.recordError(fakeCommand);
      helpSystem.recordError(fakeCommand);
      const tier3 = helpSystem.getHelp(fakeCommand, suggestion);
      const hasTier3Elements = tier3.includes('man') && tier3.includes('help');
      logTest('tier-output', 'Tier 3: Persistent Error (Full Help Reference)', hasTier3Elements,
        `Should reference man pages.\nGot: ${tier3.substring(0, 150)}...`);

      // Test error count tracking
      const errorCount = helpSystem.errorCount[fakeCommand] || 0;
      logTest('tier-output', 'Error Count Tracking', errorCount === 5,
        `Expected 5 recorded errors, got ${errorCount}`);

      output.innerHTML += '\n<span class="success">‚úÖ 3-Tier help system tests completed!</span>';
    };

    window.runManPageTests = async function() {
      const output = document.getElementById('man-output');
      output.innerHTML = '<span class="info">Running man page tests for all 30 commands...</span>\n\n';

      const allCommands = registry.list();
      const context = {
        user: 'hacker',
        cwd: '/',
        terminal: {
          getRegistry: () => registry,
          getVFS: () => vfs,
          getHistory: () => historyManager
        }
      };

      for (const cmdName of allCommands) {
        const handler = registry.get(cmdName);

        // Check if manPage property exists
        const hasManPage = handler && handler.manPage;

        if (hasManPage) {
          // Try to execute man command
          try {
            const result = await registry.execute('man', [cmdName], {}, context);
            const hasContent = result && result.length > 50 && result.includes('NAAM');

            logTest('man-output', `man ${cmdName}`, hasContent,
              hasContent ? `‚úì Man page found (${result.length} chars)` : '‚úó Man page empty or malformed');
          } catch (err) {
            logTest('man-output', `man ${cmdName}`, false, `‚úó Error: ${err.message}`);
          }
        } else {
          logTest('man-output', `man ${cmdName}`, false, '‚úó No manPage property found');
        }
      }

      output.innerHTML += `\n<span class="success">‚úÖ Man page tests completed for ${allCommands.length} commands!</span>`;
    };

    window.runIntegrationTest = async function() {
      const output = document.getElementById('integration-output');
      output.innerHTML = '<span class="info">Running integration test...</span>\n\n';

      // Reset help system
      helpSystem.errorCount = {};

      const context = {
        user: 'hacker',
        cwd: '/',
        terminal: {
          getRegistry: () => registry,
          getVFS: () => vfs,
          getHistory: () => historyManager
        }
      };

      // Step 1: Type typo, get fuzzy suggestion
      output.innerHTML += '<span class="warning">Step 1: User types typo "pimg"</span>\n';
      const allCommands = registry.list();
      const suggestion = fuzzy.findClosestCommand('pimg', allCommands, 2);

      logTest('integration-output', 'Step 1: Fuzzy Match', suggestion === 'ping',
        `Got suggestion: "${suggestion}"`);

      // Step 2: Get Tier 1 help
      output.innerHTML += '<span class="warning">Step 2: Get Tier 1 help message</span>\n';
      helpSystem.recordError('pimg');
      const tier1Help = helpSystem.getHelp('pimg', suggestion);

      logTest('integration-output', 'Step 2: Tier 1 Help', tier1Help.includes('Bedoelde je'),
        tier1Help.substring(0, 100));

      // Step 3: Repeat typo, get Tier 2
      output.innerHTML += '<span class="warning">Step 3: User repeats typo (2nd time)</span>\n';
      helpSystem.recordError('pimg');
      helpSystem.recordError('pimg');
      const tier2Help = helpSystem.getHelp('pimg', suggestion);

      logTest('integration-output', 'Step 3: Tier 2 Help', tier2Help.includes('üí°'),
        tier2Help.substring(0, 150));

      // Step 4: Use man command to get full help
      output.innerHTML += '<span class="warning">Step 4: User tries "man ping"</span>\n';
      try {
        const manOutput = await registry.execute('man', ['ping'], {}, context);
        const hasFullHelp = manOutput.includes('NAAM') && manOutput.includes('ping');

        logTest('integration-output', 'Step 4: Man Page Access', hasFullHelp,
          `Man page available: ${manOutput.length} chars`);
      } catch (err) {
        logTest('integration-output', 'Step 4: Man Page Access', false, `Error: ${err.message}`);
      }

      // Step 5: Finally execute correct command
      output.innerHTML += '<span class="warning">Step 5: User executes correct "ping 8.8.8.8"</span>\n';
      try {
        const pingOutput = await registry.execute('ping', ['8.8.8.8'], {}, context);
        const hasValidOutput = pingOutput.includes('bytes') || pingOutput.includes('ms');

        logTest('integration-output', 'Step 5: Command Execution', hasValidOutput,
          hasValidOutput ? '‚úì Ping executed successfully' : '‚úó Invalid output');
      } catch (err) {
        logTest('integration-output', 'Step 5: Command Execution', false, `Error: ${err.message}`);
      }

      output.innerHTML += '\n<span class="success">‚úÖ Integration test completed!</span>\n';
      output.innerHTML += '<span class="info">This simulates the complete user journey from typo to successful command execution.</span>';
    };

    window.clearOutput = clearOutput;

    // Initialize
    console.log('Test suite loaded. Registry has', registry.list().length, 'commands.');
  </script>
</body>
</html>
