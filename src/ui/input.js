import e from"../core/history.js";import t from"./autocomplete.js";import a from"./history-search.js";export default new class{constructor(){this.inputElement=null,this.terminal=null,this.onSubmitCallback=null,this.onSearchPromptUpdate=null,this.currentInput="",this.isProgrammaticChange=!1}init(e,t,a){if(!e)throw new Error("Input element is required");if("function"!=typeof t)throw new Error("onSubmit callback is required");if(!a)throw new Error("Terminal instance is required");this.inputElement=e,this.onSubmitCallback=t,this.terminal=a,this._attachListeners(),this.focus()}setSearchPromptCallback(e){this.onSearchPromptUpdate=e}_attachListeners(){this.inputElement.addEventListener("keydown",e=>{this._handleKeyDown(e)}),this.inputElement.addEventListener("input",r=>{this.currentInput=r.target.value,this.isProgrammaticChange||(a.isSearchActive()?(a.updateSearch(this.currentInput),this._updateSearchPrompt()):(e.resetIndex(),t.reset())),this.isProgrammaticChange=!1}),document.addEventListener("click",e=>{e.target.closest(".modal.active")||this.focus()})}_handleKeyDown(e){if(a.isSearchActive())this._handleSearchModeKeys(e);else switch(e.key){case"Enter":e.preventDefault(),this._handleSubmit();break;case"ArrowUp":e.preventDefault(),this._handleHistoryPrevious();break;case"ArrowDown":e.preventDefault(),this._handleHistoryNext();break;case"Tab":e.preventDefault(),this._handleAutocomplete();break;case"r":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this._handleHistorySearchStart());break;case"l":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this._handleClear());break;case"c":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this._handleCancel());break;case"Home":e.preventDefault(),this._handleScrollToTop();break;case"End":e.preventDefault(),this._handleScrollToBottom()}}_handleSearchModeKeys(e){switch(e.key){case"Enter":e.preventDefault(),this._handleSearchAccept();break;case"Escape":e.preventDefault(),this._handleSearchCancel();break;case"ArrowUp":e.preventDefault(),this._handleSearchPrevious();break;case"ArrowDown":e.preventDefault(),this._handleSearchNext();break;case"r":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this._handleSearchNext());break;case"c":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this._handleSearchCancel())}}_handleSubmit(){const e=this.getValue().trim();this.onSubmitCallback&&this.onSubmitCallback(e),this.clear(),window.matchMedia("(max-width: 768px)").matches&&(this.inputElement.blur(),setTimeout(()=>{if(this.terminal&&this.terminal.getOutputElement()){const e=this.terminal.getOutputElement();e.scrollTop=e.scrollHeight}},300))}_handleHistoryPrevious(){const t=e.previous();null!==t&&this.setValue(t)}_handleHistoryNext(){const t=e.next();null!==t&&this.setValue(t)}_handleAutocomplete(){const e=this.getValue(),a=t.complete(e);a&&this.setValue(a)}_handleHistorySearchStart(){a.start();const e=this.getValue();a.updateSearch(e),this._updateSearchPrompt()}_handleSearchAccept(){const e=a.accept();e&&this.setValue(e),this._clearSearchPrompt()}_handleSearchCancel(){a.cancel(),this.clear(),this._clearSearchPrompt()}_handleSearchPrevious(){a.previousMatch(),this._updateSearchPrompt()}_handleSearchNext(){a.nextMatch(),this._updateSearchPrompt()}_updateSearchPrompt(){if(this.onSearchPromptUpdate){const e=a.getPromptText();this.onSearchPromptUpdate(e)}}_clearSearchPrompt(){this.onSearchPromptUpdate&&this.onSearchPromptUpdate(null)}_handleClear(){this.terminal&&this.terminal.clear(),this.clear()}_handleCancel(){this.clear()}_handleScrollToTop(){this.terminal&&this.terminal.getOutputElement()&&(this.terminal.getOutputElement().scrollTop=0)}_handleScrollToBottom(){if(!this.terminal||!this.terminal.getOutputElement())return;const e=this.terminal.getOutputElement();e.scrollTop=e.scrollHeight}getValue(){return this.inputElement?this.inputElement.value:""}setValue(e){this.inputElement&&(this.isProgrammaticChange=!0,this.inputElement.value=e,this.currentInput=e,this.inputElement.setSelectionRange(e.length,e.length))}clear(){this.setValue("")}focus(){this.inputElement&&this.inputElement.focus()}disable(){this.inputElement&&(this.inputElement.disabled=!0)}enable(){this.inputElement&&(this.inputElement.disabled=!1,this.focus())}isEmpty(){return!this.getValue().trim()}};