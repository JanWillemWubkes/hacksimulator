import t from"./parser.js";import e from"./registry.js";import r from"./history.js";import n from"../ui/renderer.js";import i from"../ui/input.js";import o from"../filesystem/vfs.js";import s from"../help/help-system.js";import m from"../utils/fuzzy.js";import a from"../ui/onboarding.js";import c from"../analytics/events.js";import tutorialManager from"../tutorial/tutorial-manager.js";import tutorialRenderer from"../tutorial/tutorial-renderer.js";import reconScenario from"../tutorial/scenarios/recon.js";export default new class{constructor(){this.isInitialized=!1,this.isExecuting=!1,this.searchPromptElement=null,this.context={terminal:this,vfs:o,historyManager:r,onboarding:a,tutorialManager:tutorialManager,cwd:"~",user:"hacker",hostname:"hacksim"}}init(t){if(this.isInitialized)return void console.warn("Terminal already initialized");const{outputElement:e,inputElement:r}=t;if(!e||!r)throw new Error("Output and input elements are required");n.init(e),n.updatePrompt(o.getCwd()),i.init(r,t=>this.execute(t),this),this._setupSearchPrompt(r),a.init(),tutorialManager.setRenderer(tutorialRenderer),tutorialManager.register(reconScenario),tutorialManager.resume(),n.renderWelcome(a),this.isInitialized=!0;const _resumeMsg=tutorialManager.getResumeMessage();_resumeMsg&&setTimeout(()=>n.renderInfo(_resumeMsg),100)}_setupSearchPrompt(t){this.searchPromptElement=document.createElement("div"),this.searchPromptElement.id="search-prompt",this.searchPromptElement.className="search-prompt",this.searchPromptElement.style.display="none",t.parentElement.insertBefore(this.searchPromptElement,t),i.setSearchPromptCallback(t=>{this._updateSearchPrompt(t)})}_updateSearchPrompt(t){this.searchPromptElement&&(null===t?(this.searchPromptElement.style.display="none",this.searchPromptElement.textContent=""):(this.searchPromptElement.style.display="block",this.searchPromptElement.textContent=t))}async execute(o){if(this.isExecuting)return;n.renderInput(o);const d=t.parse(o);if(d.command)if(r.add(o),t.isValidCommand(d.command)){if(!e.has(d.command)){s.recordError(d.command);const t=m.findClosestCommand(d.command,e.list()),r=s.getHelp(d.command,t);return n.renderError(`Command not found: ${d.command}`),n.renderInfo(r),void c.errorOccurred("command_not_found",d.command)}try{this.isExecuting=!0,i.disable();const t=await e.execute(d.command,d.args,d.flags,this.context);if(t&&n.renderOutput(t),a.markFirstVisitComplete(),this._shouldTrackCommand(d.command,d.args,t)){const t=a.recordCommand(d.command);t&&n.renderInfo(t)}const h=a.getFilesystemHint(d.command);h&&n.renderInfo(h);if(tutorialManager.isActive()&&!["tutorial","help","man","clear","history","leerpad","shortcuts"].includes(d.command)){const _tf=tutorialManager.handleCommand(d.command,d.args,d.flags,this.context);_tf&&n.renderInfo(_tf)}c.commandExecuted(d.command,!0)}catch(t){console.error("Command execution error:",t),n.renderError(`Error executing command: ${t.message}`),c.errorOccurred("execution_error",d.command)}finally{this.isExecuting=!1,i.enable()}}else n.renderError(`Invalid command: ${d.command}`)}getHelpSystem(){return s}clear(){n.clear()}setCwd(t){this.context.cwd=t,n.updatePrompt(t)}getCwd(){return this.context.cwd}getContext(){return this.context}getRegistry(){return e}getHistory(){return r}getRenderer(){return n}getOutputElement(){return n.outputElement}_shouldTrackCommand(t,e,r){const n={ping:1,nmap:1,cat:1,cd:1,mkdir:1,touch:1,rm:1,hashcat:1,hydra:1,sqlmap:1,metasploit:1,nikto:1};if(["help","ls","pwd","whoami","history","ifconfig","netstat","date","leerpad","shortcuts","tutorial"].includes(t))return!0;if(n[t]){const i=n[t];return!(e.length<i)&&!(r&&(r.includes("Usage:")||r.startsWith("Error:")))}return e.length>0}};