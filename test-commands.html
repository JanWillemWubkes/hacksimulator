<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Test - HackSimulator</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        #results {
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .test-header {
            color: #0ff;
            font-weight: bold;
            margin-top: 20px;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
    </style>
</head>
<body>
    <h1>HackSimulator Command Tests</h1>
    <div id="results"></div>

    <script type="module">
        import terminal from './src/core/terminal.js';
        import vfs from './src/filesystem/vfs.js';

        // Import and register all commands
        import clearCmd from './src/commands/system/clear.js';
        import echoCmd from './src/commands/system/echo.js';
        import whoamiCmd from './src/commands/system/whoami.js';
        import dateCmd from './src/commands/system/date.js';
        import historyCmd from './src/commands/system/history.js';
        import helpCmd from './src/commands/system/help.js';
        import manCmd from './src/commands/system/man.js';

        import lsCmd from './src/commands/filesystem/ls.js';
        import cdCmd from './src/commands/filesystem/cd.js';
        import pwdCmd from './src/commands/filesystem/pwd.js';
        import catCmd from './src/commands/filesystem/cat.js';
        import mkdirCmd from './src/commands/filesystem/mkdir.js';
        import touchCmd from './src/commands/filesystem/touch.js';
        import rmCmd from './src/commands/filesystem/rm.js';
        import cpCmd from './src/commands/filesystem/cp.js';
        import mvCmd from './src/commands/filesystem/mv.js';
        import findCmd from './src/commands/filesystem/find.js';
        import grepCmd from './src/commands/filesystem/grep.js';
        import resetCmd from './src/commands/special/reset.js';

        const results = document.getElementById('results');

        function log(msg, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            results.appendChild(div);
        }

        async function testCommand(name, args = [], flags = {}) {
            const registry = terminal.getRegistry();
            const context = { vfs, terminal };

            try {
                const result = await registry.execute(name, args, flags, context);
                log(`\n$ ${name} ${args.join(' ')}`, 'test-header');
                log(result || '(no output)', 'success');
                return true;
            } catch (error) {
                log(`\n$ ${name} ${args.join(' ')}`, 'test-header');
                log(`ERROR: ${error.message}`, 'error');
                return false;
            }
        }

        async function runTests() {
            log('=== HACKSIMULATOR COMMAND TESTS ===\n');
            log('Initializing...\n');

            // Register commands
            const registry = terminal.getRegistry();
            registry.register('clear', clearCmd);
            registry.register('echo', echoCmd);
            registry.register('whoami', whoamiCmd);
            registry.register('date', dateCmd);
            registry.register('history', historyCmd);
            registry.register('help', helpCmd);
            registry.register('man', manCmd);
            registry.register('ls', lsCmd);
            registry.register('cd', cdCmd);
            registry.register('pwd', pwdCmd);
            registry.register('cat', catCmd);
            registry.register('mkdir', mkdirCmd);
            registry.register('touch', touchCmd);
            registry.register('rm', rmCmd);
            registry.register('cp', cpCmd);
            registry.register('mv', mvCmd);
            registry.register('find', findCmd);
            registry.register('grep', grepCmd);
            registry.register('reset', resetCmd);

            log(`Commands registered: ${registry.list().length}\n`, 'success');

            // === BASIC NAVIGATION TESTS ===
            log('\n=== BASIC NAVIGATION ===', 'test-header');
            await testCommand('pwd');
            await testCommand('ls');
            await testCommand('ls', [], { l: true });

            // === DIRECTORY NAVIGATION ===
            log('\n=== DIRECTORY NAVIGATION ===', 'test-header');
            await testCommand('cd', ['/etc']);
            await testCommand('pwd');
            await testCommand('ls');
            await testCommand('cd', ['..']);
            await testCommand('pwd');
            await testCommand('cd', ['~']);
            await testCommand('pwd');

            // === FILE READING ===
            log('\n=== FILE READING ===', 'test-header');
            await testCommand('cat', ['README.txt']);
            await testCommand('cat', ['/etc/passwd']);
            await testCommand('cat', ['/etc/shadow']); // Should be denied

            // === FILE CREATION ===
            log('\n=== FILE CREATION ===', 'test-header');
            await testCommand('touch', ['test.txt']);
            await testCommand('ls');
            await testCommand('mkdir', ['testdir']);
            await testCommand('ls');

            // === FILE MANIPULATION ===
            log('\n=== FILE MANIPULATION ===', 'test-header');
            await testCommand('cp', ['README.txt', 'README_backup.txt']);
            await testCommand('ls');
            await testCommand('mv', ['README_backup.txt', 'backup.txt']);
            await testCommand('ls');

            // === SEARCH COMMANDS ===
            log('\n=== SEARCH COMMANDS ===', 'test-header');
            await testCommand('find', ['passwd']);
            await testCommand('grep', ['root', '/etc/passwd']);
            await testCommand('grep', ['hacker', '/etc/passwd']);

            // === FILE DELETION ===
            log('\n=== FILE DELETION ===', 'test-header');
            await testCommand('rm', ['test.txt']);
            await testCommand('ls');
            await testCommand('rm', ['testdir'], { r: true });
            await testCommand('ls');

            // === ERROR TESTING ===
            log('\n=== ERROR TESTING ===', 'test-header');
            await testCommand('cat', ['nonexistent.txt']);
            await testCommand('cd', ['/nonexistent']);
            await testCommand('ls', ['/fake/path']);
            await testCommand('rm', ['/etc']); // Safety check

            // === RESET TEST ===
            log('\n=== RESET TEST ===', 'test-header');
            await testCommand('reset');
            await testCommand('ls'); // Should be back to original

            log('\n\n=== ALL TESTS COMPLETED ===', 'success');
        }

        // Run tests on load
        runTests().catch(err => {
            log(`FATAL ERROR: ${err.message}`, 'error');
            console.error(err);
        });
    </script>
</body>
</html>
